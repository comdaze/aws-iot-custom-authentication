"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isSuperObject = exports.ResourcePart = exports.HaveResourceAssertion = exports.haveResourceLike = exports.haveResource = exports.ABSENT = void 0;
const assertion_1 = require("../assertion");
const have_resource_matchers_1 = require("./have-resource-matchers");
/**
 * Magic value to signify that a certain key should be absent from the property bag.
 *
 * The property is either not present or set to `undefined.
 *
 * NOTE: `ABSENT` only works with the `haveResource()` and `haveResourceLike()`
 * assertions.
 */
exports.ABSENT = '{{ABSENT}}';
/**
 * An assertion to check whether a resource of a given type and with the given properties exists, disregarding properties
 *
 * @param resourceType the type of the resource that is expected to be present.
 * @param properties   the properties that the resource is expected to have. A function may be provided, in which case
 *                     it will be called with the properties of candidate resources and an ``InspectionFailure``
 *                     instance on which errors should be appended, and should return a truthy value to denote a match.
 * @param comparison   the entity that is being asserted against.
 * @param allowValueExtension if properties is an object, tells whether values must match exactly, or if they are
 *                     allowed to be supersets of the reference values. Meaningless if properties is a function.
 */
function haveResource(resourceType, properties, comparison, allowValueExtension = false) {
    return new HaveResourceAssertion(resourceType, properties, comparison, allowValueExtension);
}
exports.haveResource = haveResource;
/**
 * Sugar for calling ``haveResource`` with ``allowValueExtension`` set to ``true``.
 */
function haveResourceLike(resourceType, properties, comparison) {
    return haveResource(resourceType, properties, comparison, true);
}
exports.haveResourceLike = haveResourceLike;
class HaveResourceAssertion extends assertion_1.JestFriendlyAssertion {
    constructor(resourceType, properties, part, allowValueExtension = false) {
        super();
        this.resourceType = resourceType;
        this.inspected = [];
        this.matcher = isCallable(properties) ? properties :
            properties === undefined ? have_resource_matchers_1.anything() :
                allowValueExtension ? have_resource_matchers_1.deepObjectLike(properties) :
                    have_resource_matchers_1.objectLike(properties);
        this.part = part !== undefined ? part : ResourcePart.Properties;
    }
    assertUsing(inspector) {
        for (const logicalId of Object.keys(inspector.value.Resources || {})) {
            const resource = inspector.value.Resources[logicalId];
            if (resource.Type === this.resourceType) {
                const propsToCheck = this.part === ResourcePart.Properties ? resource.Properties : resource;
                // Pass inspection object as 2nd argument, initialize failure with default string,
                // to maintain backwards compatibility with old predicate API.
                const inspection = { resource, failureReason: 'Object did not match predicate' };
                if (have_resource_matchers_1.match(propsToCheck, this.matcher, inspection)) {
                    return true;
                }
                this.inspected.push(inspection);
            }
        }
        return false;
    }
    generateErrorMessage() {
        const lines = [];
        lines.push(`None of ${this.inspected.length} resources matches ${this.description}.`);
        for (const inspected of this.inspected) {
            lines.push(`- ${inspected.failureReason} in:`);
            lines.push(indent(4, JSON.stringify(inspected.resource, null, 2)));
        }
        return lines.join('\n');
    }
    assertOrThrow(inspector) {
        if (!this.assertUsing(inspector)) {
            throw new Error(this.generateErrorMessage());
        }
    }
    get description() {
        // eslint-disable-next-line max-len
        return `resource '${this.resourceType}' with ${JSON.stringify(this.matcher, undefined, 2)}`;
    }
}
exports.HaveResourceAssertion = HaveResourceAssertion;
function indent(n, s) {
    const prefix = ' '.repeat(n);
    return prefix + s.replace(/\n/g, '\n' + prefix);
}
/**
 * What part of the resource to compare
 */
var ResourcePart;
(function (ResourcePart) {
    /**
     * Only compare the resource's properties
     */
    ResourcePart[ResourcePart["Properties"] = 0] = "Properties";
    /**
     * Check the entire CloudFormation config
     *
     * (including UpdateConfig, DependsOn, etc.)
     */
    ResourcePart[ResourcePart["CompleteDefinition"] = 1] = "CompleteDefinition";
})(ResourcePart = exports.ResourcePart || (exports.ResourcePart = {}));
/**
 * Whether a value is a callable
 */
function isCallable(x) {
    return x && {}.toString.call(x) === '[object Function]';
}
/**
 * Return whether `superObj` is a super-object of `obj`.
 *
 * A super-object has the same or more property values, recursing into sub properties if ``allowValueExtension`` is true.
 *
 * At any point in the object, a value may be replaced with a function which will be used to check that particular field.
 * The type of a matcher function is expected to be of type PropertyMatcher.
 *
 * @deprecated - Use `objectLike` or a literal object instead.
 */
function isSuperObject(superObj, pattern, errors = [], allowValueExtension = false) {
    const matcher = allowValueExtension ? have_resource_matchers_1.deepObjectLike(pattern) : have_resource_matchers_1.objectLike(pattern);
    const inspection = { resource: superObj, failureReason: '' };
    const ret = have_resource_matchers_1.match(superObj, matcher, inspection);
    if (!ret) {
        errors.push(inspection.failureReason);
    }
    return ret;
}
exports.isSuperObject = isSuperObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGF2ZS1yZXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhhdmUtcmVzb3VyY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNENBQWdFO0FBRWhFLHFFQUF1RjtBQUV2Rjs7Ozs7OztHQU9HO0FBQ1UsUUFBQSxNQUFNLEdBQUcsWUFBWSxDQUFDO0FBRW5DOzs7Ozs7Ozs7O0dBVUc7QUFDSCxTQUFnQixZQUFZLENBQzFCLFlBQW9CLEVBQ3BCLFVBQWdCLEVBQ2hCLFVBQXlCLEVBQ3pCLHNCQUErQixLQUFLO0lBQ3BDLE9BQU8sSUFBSSxxQkFBcUIsQ0FBQyxZQUFZLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0FBQzlGLENBQUM7QUFORCxvQ0FNQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsZ0JBQWdCLENBQzlCLFlBQW9CLEVBQ3BCLFVBQWdCLEVBQ2hCLFVBQXlCO0lBQ3pCLE9BQU8sWUFBWSxDQUFDLFlBQVksRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ2xFLENBQUM7QUFMRCw0Q0FLQztBQUlELE1BQWEscUJBQXNCLFNBQVEsaUNBQXFDO0lBSzlFLFlBQ21CLFlBQW9CLEVBQ3JDLFVBQWdCLEVBQ2hCLElBQW1CLEVBQ25CLHNCQUErQixLQUFLO1FBQ3BDLEtBQUssRUFBRSxDQUFDO1FBSlMsaUJBQVksR0FBWixZQUFZLENBQVE7UUFMdEIsY0FBUyxHQUF3QixFQUFFLENBQUM7UUFXbkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2xELFVBQVUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLGlDQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsdUNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO29CQUNoRCxtQ0FBVSxDQUFDLFVB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QjtBQUVEOztHQUVHO0FBQ0gsU0FBUyxVQUFVLENBQUMsQ0FBTTtJQUN4QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxtQkFBbUIsQ0FBQztBQUMxRCxDQUFDO0FBRUQ7Ozs7Ozs7OztHQVNHO0FBQ0gsU0FBZ0IsYUFBYSxDQUFDLFFBQWEsRUFBRSxPQUFZLEVBQUUsU0FBbUIsRUFBRSxFQUFFLHNCQUErQixLQUFLO0lBQ3BILE1BQU0sT0FBTyxHQUFHLG1CQUFtQixDQUFDLENBQUMsQ0FBQyx1Q0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQ0FBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXBGLE1BQU0sVUFBVSxHQUFzQixFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQ2hGLE1BQU0sR0FBRyxHQUFHLDhCQUFLLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNqRCxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQ1IsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDdkM7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFURCxzQ0FTQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2VydGlvbiwgSmVzdEZyaWVuZGx5QXNzZXJ0aW9uIH0gZnJvbSAnLi4vYXNzZXJ0aW9uJztcbmltcG9ydCB7IFN0YWNrSW5zcGVjdG9yIH0gZnJvbSAnLi4vaW5zcGVjdG9yJztcbmltcG9ydCB7IGFueXRoaW5nLCBkZWVwT2JqZWN0TGlrZSwgbWF0Y2gsIG9iamVjdExpa2UgfSBmcm9tICcuL2hhdmUtcmVzb3VyY2UtbWF0Y2hlcnMnO1xuXG4vKipcbiAqIE1hZ2ljIHZhbHVlIHRvIHNpZ25pZnkgdGhhdCBhIGNlcnRhaW4ga2V5IHNob3VsZCBiZSBhYnNlbnQgZnJvbSB0aGUgcHJvcGVydHkgYmFnLlxuICpcbiAqIFRoZSBwcm9wZXJ0eSBpcyBlaXRoZXIgbm90IHByZXNlbnQgb3Igc2V0IHRvIGB1bmRlZmluZWQuXG4gKlxuICogTk9URTogYEFCU0VOVGAgb25seSB3b3JrcyB3aXRoIHRoZSBgaGF2ZVJlc291cmNlKClgIGFuZCBgaGF2ZVJlc291cmNlTGlrZSgpYFxuICogYXNzZXJ0aW9ucy5cbiAqL1xuZXhwb3J0IGNvbnN0IEFCU0VOVCA9ICd7e0FCU0VOVH19JztcblxuLyoqXG4gKiBBbiBhc3NlcnRpb24gdG8gY2hlY2sgd2hldGhlciBhIHJlc291cmNlIG9mIGEgZ2l2ZW4gdHlwZSBhbmQgd2l0aCB0aGUgZ2l2ZW4gcHJvcGVydGllcyBleGlzdHMsIGRpc3JlZ2FyZGluZyBwcm9wZXJ0aWVzXG4gKlxuICogQHBhcmFtIHJlc291cmNlVHlwZSB0aGUgdHlwZSBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBleHBlY3RlZCB0byBiZSBwcmVzZW50LlxuICogQHBhcmFtIHByb3BlcnRpZXMgICB0aGUgcHJvcGVydGllcyB0aGF0IHRoZSByZXNvdXJjZSBpcyBleHBlY3RlZCB0byBoYXZlLiBBIGZ1bmN0aW9uIG1heSBiZSBwcm92aWRlZCwgaW4gd2hpY2ggY2FzZVxuICogICAgICAgICAgICAgICAgICAgICBpdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBwcm9wZXJ0aWVzIG9mIGNhbmRpZGF0ZSByZXNvdXJjZXMgYW5kIGFuIGBgSW5zcGVjdGlvbkZhaWx1cmVgYFxuICogICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSBvbiB3aGljaCBlcnJvcnMgc2hvdWxkIGJlIGFwcGVuZGVkLCBhbmQgc2hvdWxkIHJldHVybiBhIHRydXRoeSB2YWx1ZSB0byBkZW5vdGUgYSBtYXRjaC5cbiAqIEBwYXJhbSBjb21wYXJpc29uICAgdGhlIGVudGl0eSB0aGF0IGlzIGJlaW5nIGFzc2VydGVkIGFnYWluc3QuXG4gKiBAcGFyYW0gYWxsb3dWYWx1ZUV4dGVuc2lvbiBpZiBwcm9wZXJ0aWVzIGlzIGFuIG9iamVjdCwgdGVsbHMgd2hldGhlciB2YWx1ZXMgbXVzdCBtYXRjaCBleGFjdGx5LCBvciBpZiB0aGV5IGFyZVxuICogICAgICAgICAgICAgICAgICAgICBhbGxvd2VkIHRvIGJlIHN1cGVyc2V0cyBvZiB0aGUgcmVmZXJlbmNlIHZhbHVlcy4gTWVhbmluZ2xlc3MgaWYgcHJvcGVydGllcyBpcyBhIGZ1bmN0aW9uLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaGF2ZVJlc291cmNlKFxuICByZXNvdXJjZVR5cGU6IHN0cmluZyxcbiAgcHJvcGVydGllcz86IGFueSxcbiAgY29tcGFyaXNvbj86IFJlc291cmNlUGFydCxcbiAgYWxsb3dWYWx1ZUV4dGVuc2lvbjogYm9vbGVhbiA9IGZhbHNlKTogQXNzZXJ0aW9uPFN0YWNrSW5zcGVjdG9yPiB7XG4gIHJldHVybiBuZXcgSGF2ZVJlc291cmNlQXNzZXJ0aW9uKHJlc291cmNlVHlwZSwgcHJvcGVydGllcywgY29tcGFyaXNvbiwgYWxsb3dWYWx1ZUV4dGVuc2lvbik7XG59XG5cbi8qKlxuICogU3VnYXIgZm9yIGNhbGxpbmcgYGBoYXZlUmVzb3VyY2VgYCB3aXRoIGBgYWxsb3dWYWx1ZUV4dGVuc2lvbmBgIHNldCB0byBgYHRydWVgYC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhhdmVSZXNvdXJjZUxpa2UoXG4gIHJlc291cmNlVHlwZTogc3RyaW5nLFxuICBwcm9wZXJ0aWVzPzogYW55LFxuICBjb21wYXJpc29uPzogUmVzb3VyY2VQYXJ0KSB7XG4gIHJldHVybiBoYXZlUmVzb3VyY2UocmVzb3VyY2VUeXBlLCBwcm9wZXJ0aWVzLCBjb21wYXJpc29uLCB0cnVlKTtcbn1cblxuZXhwb3J0IHR5cGUgUHJvcGVydHlNYXRjaGVyID0gKHByb3BzOiBhbnksIGluc3BlY3Rpb246IEluc3BlY3Rpb25GYWlsdXJlKSA9PiBib29sZWFuO1xuXG5leHBvcnQgY2xhc3MgSGF2ZVJlc291cmNlQXNzZXJ0aW9uIGV4dGVuZHMgSmVzdEZyaWVuZGx5QXNzZXJ0aW9uPFN0YWNrSW5zcGVjdG9yPiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW5zcGVjdGVkOiBJbnNwZWN0aW9uRmFpbHVyZVtdID0gW107XG4gIHByaXZhdGUgcmVhZG9ubHkgcGFydDogUmVzb3VyY2VQYXJ0O1xuICBwcml2YXRlIHJlYWRvbmx5IG1hdGNoZXI6IGFueTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlc291cmNlVHlwZTogc3RyaW5nLFxuICAgIHByb3BlcnRpZXM/OiBhbnksXG4gICAgcGFydD86IFJlc291cmNlUGFydCxcbiAgICBhbGxvd1ZhbHVlRXh0ZW5zaW9uOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5tYXRjaGVyID0gaXNDYWxsYWJsZShwcm9wZXJ0aWVzKSA/IHByb3BlcnRpZXMgOlxuICAgICAgcHJvcGVydGllcyA9PT0gdW5kZWZpbmVkID8gYW55dGhpbmcoKSA6XG4gICAgICAgIGFsbG93VmFsdWVFeHRlbnNpb24gPyBkZWVwT2JqZWN0TGlrZShwcm9wZXJ0aWVzKSA6XG4gICAgICAgICAgb2JqZWN0TGlrZShwcm9wZXJ0aWVzKTtcbiAgICB0aGlzLnBhcnQgPSBwYXJ0ICE9PSB1bmRlZmluZWQgPyBwYXJ0IDogUmVzb3VyY2VQYXJ0LlByb3BlcnRpZXM7XG4gIH1cblxuICBwdWJsaWMgYXNzZXJ0VXNpbmcoaW5zcGVjdG9yOiBTdGFja0luc3BlY3Rvcik6IGJvb2xlYW4ge1xuICAgIGZvciAoY29uc3QgbG9naWNhbElkIG9mIE9iamVjdC5rZXlzKGluc3BlY3Rvci52YWx1ZS5SZXNvdXJjZXMgfHwge30pKSB7XG4gICAgICBjb25zdCByZXNvdXJjZSA9IGluc3BlY3Rvci52YWx1ZS5SZXNvdXJjZXNbbG9naWNhbElkXTtcbiAgICAgIGlmIChyZXNvdXJjZS5UeXBlID09PSB0aGlzLnJlc291cmNlVHlwZSkge1xuICAgICAgICBjb25zdCBwcm9wc1RvQ2hlY2sgPSB0aGlzLnBhcnQgPT09IFJlc291cmNlUGFydC5Qcm9wZXJ0aWVzID8gcmVzb3VyY2UuUHJvcGVydGllcyA6IHJlc291cmNlO1xuXG4gICAgICAgIC8vIFBhc3MgaW5zcGVjdGlvbiBvYmplY3QgYXMgMm5kIGFyZ3VtZW50LCBpbml0aWFsaXplIGZhaWx1cmUgd2l0aCBkZWZhdWx0IHN0cmluZyxcbiAgICAgICAgLy8gdG8gbWFpbnRhaW4gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgcHJlZGljYXRlIEFQSS5cbiAgICAgICAgY29uc3QgaW5zcGVjdGlvbiA9IHsgcmVzb3VyY2UsIGZhaWx1cmVSZWFzb246ICdPYmplY3QgZGlkIG5vdCBtYXRjaCBwcmVkaWNhdGUnIH07XG5cbiAgICAgICAgaWYgKG1hdGNoKHByb3BzVG9DaGVjaywgdGhpcy5tYXRjaGVyLCBpbnNwZWN0aW9uKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pbnNwZWN0ZWQucHVzaChpbnNwZWN0aW9uKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgZ2VuZXJhdGVFcnJvck1lc3NhZ2UoKSB7XG4gICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG4gICAgbGluZXMucHVzaChgTm9uZSBvZiAke3RoaXMuaW5zcGVjdGVkLmxlbmd0aH0gcmVzb3VyY2VzIG1hdGNoZXMgJHt0aGlzLmRlc2NyaXB0aW9ufS5gKTtcblxuICAgIGZvciAoY29uc3QgaW5zcGVjdGVkIG9mIHRoaXMuaW5zcGVjdGVkKSB7XG4gICAgICBsaW5lcy5wdXNoKGAtICR7aW5zcGVjdGVkLmZhaWx1cmVSZWFzb259IGluOmApO1xuICAgICAgbGluZXMucHVzaChpbmRlbnQoNCwgSlNPTi5zdHJpbmdpZnkoaW5zcGVjdGVkLnJlc291cmNlLCBudWxsLCAyKSkpO1xuICAgIH1cblxuICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3NlcnRPclRocm93KGluc3BlY3RvcjogU3RhY2tJbnNwZWN0b3IpIHtcbiAgICBpZiAoIXRoaXMuYXNzZXJ0VXNpbmcoaW5zcGVjdG9yKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuZ2VuZXJhdGVFcnJvck1lc3NhZ2UoKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBkZXNjcmlwdGlvbigpOiBzdHJpbmcge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgcmV0dXJuIGByZXNvdXJjZSAnJHt0aGlzLnJlc291cmNlVHlwZX0nIHdpdGggJHtKU09OLnN0cmluZ2lmeSh0aGlzLm1hdGNoZXIsIHVuZGVmaW5lZCwgMil9YDtcbiAgfVxufVxuXG5mdW5jdGlvbiBpbmRlbnQobjogbnVtYmVyLCBzOiBzdHJpbmcpIHtcbiAgY29uc3QgcHJlZml4ID0gJyAnLnJlcGVhdChuKTtcbiAgcmV0dXJuIHByZWZpeCArIHMucmVwbGFjZSgvXFxuL2csICdcXG4nICsgcHJlZml4KTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbnNwZWN0aW9uRmFpbHVyZSB7XG4gIHJlc291cmNlOiBhbnk7XG4gIGZhaWx1cmVSZWFzb246IHN0cmluZztcbn1cblxuLyoqXG4gKiBXaGF0IHBhcnQgb2YgdGhlIHJlc291cmNlIHRvIGNvbXBhcmVcbiAqL1xuZXhwb3J0IGVudW0gUmVzb3VyY2VQYXJ0IHtcbiAgLyoqXG4gICAqIE9ubHkgY29tcGFyZSB0aGUgcmVzb3VyY2UncyBwcm9wZXJ0aWVzXG4gICAqL1xuICBQcm9wZXJ0aWVzLFxuXG4gIC8qKlxuICAgKiBDaGVjayB0aGUgZW50aXJlIENsb3VkRm9ybWF0aW9uIGNvbmZpZ1xuICAgKlxuICAgKiAoaW5jbHVkaW5nIFVwZGF0ZUNvbmZpZywgRGVwZW5kc09uLCBldGMuKVxuICAgKi9cbiAgQ29tcGxldGVEZWZpbml0aW9uXG59XG5cbi8qKlxuICogV2hldGhlciBhIHZhbHVlIGlzIGEgY2FsbGFibGVcbiAqL1xuZnVuY3Rpb24gaXNDYWxsYWJsZSh4OiBhbnkpOiB4IGlzICgoLi4uYXJnczogYW55W10pID0+IGFueSkge1xuICByZXR1cm4geCAmJiB7fS50b1N0cmluZy5jYWxsKHgpID09PSAnW29iamVjdCBGdW5jdGlvbl0nO1xufVxuXG4vKipcbiAqIFJldHVybiB3aGV0aGVyIGBzdXBlck9iamAgaXMgYSBzdXBlci1vYmplY3Qgb2YgYG9iamAuXG4gKlxuICogQSBzdXBlci1vYmplY3QgaGFzIHRoZSBzYW1lIG9yIG1vcmUgcHJvcGVydHkgdmFsdWVzLCByZWN1cnNpbmcgaW50byBzdWIgcHJvcGVydGllcyBpZiBgYGFsbG93VmFsdWVFeHRlbnNpb25gYCBpcyB0cnVlLlxuICpcbiAqIEF0IGFueSBwb2ludCBpbiB0aGUgb2JqZWN0LCBhIHZhbHVlIG1heSBiZSByZXBsYWNlZCB3aXRoIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBiZSB1c2VkIHRvIGNoZWNrIHRoYXQgcGFydGljdWxhciBmaWVsZC5cbiAqIFRoZSB0eXBlIG9mIGEgbWF0Y2hlciBmdW5jdGlvbiBpcyBleHBlY3RlZCB0byBiZSBvZiB0eXBlIFByb3BlcnR5TWF0Y2hlci5cbiAqXG4gKiBAZGVwcmVjYXRlZCAtIFVzZSBgb2JqZWN0TGlrZWAgb3IgYSBsaXRlcmFsIG9iamVjdCBpbnN0ZWFkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNTdXBlck9iamVjdChzdXBlck9iajogYW55LCBwYXR0ZXJuOiBhbnksIGVycm9yczogc3RyaW5nW10gPSBbXSwgYWxsb3dWYWx1ZUV4dGVuc2lvbjogYm9vbGVhbiA9IGZhbHNlKTogYm9vbGVhbiB7XG4gIGNvbnN0IG1hdGNoZXIgPSBhbGxvd1ZhbHVlRXh0ZW5zaW9uID8gZGVlcE9iamVjdExpa2UocGF0dGVybikgOiBvYmplY3RMaWtlKHBhdHRlcm4pO1xuXG4gIGNvbnN0IGluc3BlY3Rpb246IEluc3BlY3Rpb25GYWlsdXJlID0geyByZXNvdXJjZTogc3VwZXJPYmosIGZhaWx1cmVSZWFzb246ICcnIH07XG4gIGNvbnN0IHJldCA9IG1hdGNoKHN1cGVyT2JqLCBtYXRjaGVyLCBpbnNwZWN0aW9uKTtcbiAgaWYgKCFyZXQpIHtcbiAgICBlcnJvcnMucHVzaChpbnNwZWN0aW9uLmZhaWx1cmVSZWFzb24pO1xuICB9XG4gIHJldHVybiByZXQ7XG59XG4iXX0=